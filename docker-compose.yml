# Production Docker Compose Configuration
# Uses Cloudflare Tunnel for reverse proxy, SSL, and domain routing
# For Coolify deployment: Coolify's Traefik can be used instead of cloudflared
#
# Deployment Options:
# 1. Cloudflare Tunnel (default): Uses cloudflared for public access
# 2. Coolify/Traefik: Remove cloudflared service, let Coolify handle routing

services:
  # Cloudflare Tunnel (primary reverse proxy for production)
  # Handles SSL termination at Cloudflare edge
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: ${COMPOSE_PROJECT_NAME:-ecommerce}-tunnel
    command: tunnel --config /etc/cloudflared/config.yml run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    depends_on:
      - app
      - pocketbase
      - umami
    restart: unless-stopped
    networks:
      - app-network
    profiles:
      - tunnel  # Use: docker compose --profile tunnel up

  # Next.js Application
  # Domain: shop.cafemomiji.com
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_POCKETBASE_URL=${PUBLIC_POCKETBASE_URL:-https://api.cafemomiji.com}
        - NEXT_PUBLIC_SITE_URL=${PUBLIC_SITE_URL:-https://shop.cafemomiji.com}
        - NEXT_PUBLIC_STORE_NAME=${STORE_NAME:-My Store}
        - NEXT_PUBLIC_STORE_DESCRIPTION=${STORE_DESCRIPTION:-Your online store}
        - NEXT_PUBLIC_ADMIN_EMAIL=${NEXT_PUBLIC_ADMIN_EMAIL:-}
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
      - POCKETBASE_INTERNAL_URL=http://pocketbase:8090
      - NEXT_PUBLIC_POCKETBASE_URL=${PUBLIC_POCKETBASE_URL:-https://api.cafemomiji.com}
      - NEXT_PUBLIC_UMAMI_URL=${PUBLIC_UMAMI_URL:-https://analytics.cafemomiji.com}
      - NEXT_PUBLIC_PHOTON_URL=${PHOTON_URL:-https://photon.komoot.io}
      - NEXT_PUBLIC_STORE_NAME=${STORE_NAME:-My Store}
      - NEXT_PUBLIC_STORE_DESCRIPTION=${STORE_DESCRIPTION:-Your online store for great products}
      - NEXT_PUBLIC_SITE_URL=${PUBLIC_SITE_URL:-https://shop.cafemomiji.com}
      - REDIS_URL=redis://redis:6379
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM:-noreply@example.com}
      - NEXT_PUBLIC_HCAPTCHA_SITE_KEY=${HCAPTCHA_SITE_KEY}
      - HCAPTCHA_SECRET_KEY=${HCAPTCHA_SECRET_KEY}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - NEXT_PUBLIC_ADMIN_EMAIL=${NEXT_PUBLIC_ADMIN_EMAIL:-}
      - STORE_NAME=${STORE_NAME:-My Store}
      - ORDER_PREFIX=${ORDER_PREFIX:-ORD}
      - CURRENCY_SYMBOL=${CURRENCY_SYMBOL:-$}
      - SHIPPING_FLAT_RATE=${SHIPPING_FLAT_RATE:-500}
      - FREE_SHIPPING_THRESHOLD=${FREE_SHIPPING_THRESHOLD:-5000}
      - PROCESSING_STATUS_NAME=${PROCESSING_STATUS_NAME:-processing}
      - SITE_PASSWORD=${SITE_PASSWORD}
    depends_on:
      - pocketbase
      - redis
    restart: unless-stopped
    networks:
      - app-network

  # PocketBase (Database + Auth + Storage)
  # Domain: api.cafemomiji.com
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    expose:
      - "8090"
    volumes:
      - pocketbase_data:/pb_data
      - pocketbase_public:/pb_public
      - ./pb_migrations:/pb_migrations
    environment:
      - PB_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:-admin@example.com}
    restart: unless-stopped
    command: serve --http=0.0.0.0:8090 --dir=/pb_data --publicDir=/pb_public --migrationsDir=/pb_migrations
    networks:
      - app-network

  # Redis (Rate Limiting & Session Caching)
  # Internal only - no external domain
  redis:
    image: redis:7-alpine
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes
    networks:
      - app-network

  # Umami Analytics
  # Domain: analytics.cafemomiji.com
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    expose:
      - "3000"
    environment:
      DATABASE_URL: postgresql://umami:${UMAMI_DB_PASSWORD:-umami}@umami-db:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: ${UMAMI_APP_SECRET:-change-me-in-production}
      DISABLE_TELEMETRY: 1
    depends_on:
      umami-db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network

  # Umami PostgreSQL Database
  # Internal only - no external domain
  umami-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: ${UMAMI_DB_PASSWORD:-umami}
    volumes:
      - umami_db_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U umami -d umami"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

volumes:
  pocketbase_data:
  pocketbase_public:
  redis_data:
  umami_db_data:

networks:
  app-network:
    driver: bridge
